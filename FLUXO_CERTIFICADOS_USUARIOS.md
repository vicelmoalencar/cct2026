# üîÑ Fluxo Completo: Usu√°rios e Certificados

## üìã 3 Cen√°rios de Usu√°rios

### **Cen√°rio 1: Usu√°rio COM certificado + COM conta** ‚úÖ

**Exemplo:** antoniovicelmo@gmail.com

**Situa√ß√£o Atual:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  auth.users             ‚îÇ       ‚îÇ  certificates           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ email: antonio...       ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ user_email: antonio...  ‚îÇ
‚îÇ password: (hash)        ‚îÇ       ‚îÇ course_title: PJECALC   ‚îÇ
‚îÇ created_at: 2025-01-01  ‚îÇ       ‚îÇ verification_code: CCT  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚úÖ Existe                         ‚úÖ Existe
```

**Fluxo:**
1. üîê Login ‚Üí Token JWT
2. üìú Clica "Certificados"
3. üîç API busca: `WHERE user_email = 'antonio...'`
4. ‚úÖ **Retorna 6 certificados**
5. üéâ Usu√°rio v√™, baixa PDF, compartilha

**A√ß√µes necess√°rias:** ‚úÖ Nenhuma! Sistema funciona.

---

### **Cen√°rio 2: Usu√°rio COM certificado + SEM conta** ‚ö†Ô∏è

**Exemplo:** 89 outros usu√°rios do certificados.csv

**Situa√ß√£o Atual:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  auth.users             ‚îÇ       ‚îÇ  certificates           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ (vazio)                 ‚îÇ   X   ‚îÇ user_email: ricardo...  ‚îÇ
‚îÇ                         ‚îÇ       ‚îÇ course_title: PJECALC   ‚îÇ
‚îÇ                         ‚îÇ       ‚îÇ verification_code: CCT  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚ùå N√ÉO existe                    ‚úÖ Existe
```

**Problema:** Usu√°rio n√£o consegue fazer login!

**Solu√ß√£o A: Criar contas em massa (Recomendado)**

```sql
-- Execute no Supabase SQL Editor
-- Arquivo: SQL_CRIAR_USUARIOS_AUTH.sql

-- Cria contas para TODOS os usu√°rios √∫nicos de certificates
-- Senha padr√£o: 123456
-- Email pr√©-confirmado (n√£o precisa verificar)
```

**Resultado:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  auth.users             ‚îÇ       ‚îÇ  certificates           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ email: ricardo...       ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ user_email: ricardo...  ‚îÇ
‚îÇ password: 123456 (hash) ‚îÇ       ‚îÇ course_title: PJECALC   ‚îÇ
‚îÇ created_at: 2025-10-25  ‚îÇ       ‚îÇ verification_code: CCT  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚úÖ Criada agora!                 ‚úÖ J√° existia
```

**Depois da cria√ß√£o:**
1. üìß Notificar usu√°rio via email (opcional)
2. üîê Usu√°rio faz login (email + senha: 123456)
3. üîÑ Usu√°rio troca senha (opcional: implementar "force change")
4. üìú Clica "Certificados"
5. ‚úÖ **Certificados aparecem automaticamente!**

**A√ß√µes necess√°rias:**
- ‚úÖ Executar SQL de cria√ß√£o de usu√°rios (1 vez)
- ‚úÖ Enviar email com credenciais (opcional)
- ‚úÖ Implementar troca de senha obrigat√≥ria (opcional)

---

**Solu√ß√£o B: Auto-registro (Self-service)**

Usu√°rio acessa plataforma e se registra:

```
1. Clica "Registrar"
2. Preenche:
   - Nome: Ricardo Silva
   - Email: ricardo@example.com  ‚Üê DEVE SER EXATO!
   - Senha: minhasenha123
3. Sistema cria conta em auth.users
4. Faz login
5. Clica "Certificados"
6. ‚úÖ Certificados aparecem (match por email)
```

**‚ö†Ô∏è IMPORTANTE:**
- Email deve ser **exatamente igual** ao da tabela certificates
- Case sensitive: `ricardo@example.com` ‚â† `Ricardo@example.com`
- Dom√≠nio deve ser igual: `ricardo@gmail.com` ‚â† `ricardo@outlook.com`

**A√ß√µes necess√°rias:**
- ‚úÖ Nenhuma! Usu√°rio faz tudo sozinho
- ‚ö†Ô∏è Risco: Usu√°rio errar o email e n√£o ver certificados

---

### **Cen√°rio 3: Usu√°rio NOVO sem certificados** üÜï

**Exemplo:** Algu√©m que nunca fez curso

**Situa√ß√£o Atual:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  auth.users             ‚îÇ       ‚îÇ  certificates           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§       ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ (vazio)                 ‚îÇ   X   ‚îÇ (vazio)                 ‚îÇ
‚îÇ                         ‚îÇ       ‚îÇ                         ‚îÇ
‚îÇ                         ‚îÇ       ‚îÇ                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚ùå N√ÉO existe                    ‚ùå N√ÉO existe
```

**Fluxo:**
1. üÜï Usu√°rio clica "Registrar"
2. üìù Preenche: Nome, Email, Senha
3. ‚úÖ Conta criada em auth.users
4. üîê Faz login
5. üìú Clica "Certificados"
6. üì≠ **V√™: "Nenhum certificado dispon√≠vel"**

**Como ter√° certificados no futuro?**

#### **Op√ß√£o A: Completar curso (Sistema autom√°tico)**

```
1. Usu√°rio assiste aulas
2. Marca todas como "Conclu√≠da"
3. Atinge 100% de progresso
4. Sistema gera certificado automaticamente:
   - INSERT INTO certificates (user_email, course_title, ...)
   - verification_code gerado automaticamente
5. ‚úÖ Certificado aparece na p√°gina "Certificados"
```

**‚ö†Ô∏è NOTA:** Esse sistema de conclus√£o autom√°tica precisa ser implementado!

#### **Op√ß√£o B: Admin adiciona manualmente**

**Via Admin Panel:**
1. Admin acessa painel admin
2. Vai em "Certificados"
3. Clica "Adicionar Certificado"
4. Preenche:
   - Email: novo@example.com
   - Nome: Jo√£o Silva
   - Curso: PJECALCPLUS
   - Carga hor√°ria: 60h
5. ‚úÖ Certificado criado com c√≥digo √∫nico
6. Usu√°rio v√™ na pr√≥xima vez que acessar

**Via CSV Import:**
1. Admin prepara CSV:
   ```
   user_email;user_name;course_title;carga_horaria
   novo@example.com;Jo√£o Silva;PJECALCPLUS;60
   ```
2. Importa via admin panel
3. ‚úÖ Certificado criado automaticamente

---

## üîç Como o Sistema Identifica o Usu√°rio?

### **Mecanismo de Matching:**

```typescript
// Endpoint: GET /api/my-certificates

async function getMyCertificates(c) {
  // 1. Extrair email do token JWT
  const user = c.get('user')  // Vem do middleware requireAuth
  const userEmail = user.email  // Ex: "antonio@gmail.com"
  
  // 2. Buscar certificados no banco
  const certificates = await supabase.query('certificates', {
    filters: { user_email: userEmail }  // Match EXATO por email
  })
  
  // 3. Retornar
  return c.json({ certificates })
}
```

**Matching = Compara√ß√£o exata de strings:**
- `WHERE user_email = 'antonio@gmail.com'`
- **Case sensitive:** `antonio` ‚â† `Antonio`
- **Dom√≠nio exato:** `gmail.com` ‚â† `outlook.com`

---

## üìä Tabela Resumo

| Cen√°rio | Conta Auth | Certificados | O que o usu√°rio v√™? | A√ß√£o necess√°ria |
|---------|------------|--------------|---------------------|-----------------|
| **1** | ‚úÖ Existe | ‚úÖ Existe | üéâ Lista certificados | Nenhuma |
| **2A** | ‚ùå N√£o existe | ‚úÖ Existe | üîí N√£o consegue login | Criar conta (SQL) |
| **2B** | ‚úÖ Auto-registro | ‚úÖ Existe | üéâ Lista certificados | Usu√°rio se registra |
| **3A** | ‚úÖ Existe | ‚ùå N√£o existe | üì≠ Mensagem "nenhum" | Completar curso |
| **3B** | ‚úÖ Existe | ‚ùå N√£o existe | üì≠ Mensagem "nenhum" | Admin adiciona |

---

## üöÄ Implementa√ß√µes Futuras (Opcional)

### **1. Gera√ß√£o Autom√°tica ao Completar Curso**

```typescript
// Quando usu√°rio marca √∫ltima aula como conclu√≠da
app.post('/api/progress/complete', requireAuth, async (c) => {
  const { lesson_id } = await c.req.json()
  const user = c.get('user')
  
  // Marcar aula como conclu√≠da
  await markLessonComplete(user.email, lesson_id)
  
  // Verificar se completou o curso
  const progress = await getCourseProgress(user.email, course_id)
  
  if (progress.percentage === 100) {
    // ‚úÖ Gerar certificado automaticamente!
    await generateCertificate({
      user_email: user.email,
      user_name: user.user_metadata.name,
      course_id: course_id,
      course_title: course.title,
      verification_code: generateCode(),
      completion_date: new Date()
    })
    
    // üéâ Mostrar popup de parab√©ns
    return c.json({ 
      completed: true, 
      certificateGenerated: true,
      message: 'üéâ Parab√©ns! Voc√™ completou o curso e recebeu um certificado!'
    })
  }
})
```

---

### **2. Troca de Senha Obrigat√≥ria no Primeiro Login**

```typescript
// Middleware: requirePasswordChange
app.get('/profile', requireAuth, async (c) => {
  const user = c.get('user')
  
  // Verificar se senha nunca foi trocada
  const isDefaultPassword = user.user_metadata.password_changed === false
  
  if (isDefaultPassword) {
    // Redirecionar para p√°gina de troca de senha
    return c.redirect('/change-password?required=true')
  }
  
  // Continuar normalmente
  return renderProfilePage()
})
```

---

### **3. Notifica√ß√£o por Email**

```typescript
// Ap√≥s criar contas em massa
async function notifyNewUsers() {
  const newUsers = await getRecentlyCreatedUsers()
  
  for (const user of newUsers) {
    await sendEmail({
      to: user.email,
      subject: 'üéì Seu certificado CCT 2026 est√° dispon√≠vel!',
      body: `
        Ol√° ${user.name},
        
        Seu certificado do curso "${user.course}" est√° dispon√≠vel!
        
        üîê Credenciais de acesso:
        Email: ${user.email}
        Senha: 123456
        
        üåê Acesse: https://ensinoplus-dev-cct2026.n697dr.easypanel.host
        
        ‚ö†Ô∏è Recomendamos trocar sua senha ap√≥s o primeiro login.
        
        üîó C√≥digo de verifica√ß√£o: ${user.verification_code}
        Verifique em: https://seu-dominio.com/verificar/${user.verification_code}
        
        Atenciosamente,
        CCT 2026
      `
    })
  }
}
```

---

## ‚úÖ Checklist de Implementa√ß√£o

### **Para Usu√°rios Existentes (Cen√°rio 2):**
- [ ] Executar SQL_CRIAR_USUARIOS_AUTH.sql
- [ ] Verificar usu√°rios criados no Supabase Auth
- [ ] (Opcional) Enviar emails com credenciais
- [ ] (Opcional) Implementar troca de senha obrigat√≥ria
- [ ] Testar login com um dos usu√°rios criados
- [ ] Verificar se certificados aparecem

### **Para Usu√°rios Novos (Cen√°rio 3):**
- [ ] Sistema de registro j√° funciona (‚úÖ Implementado)
- [ ] Mensagem "Nenhum certificado" aparece (‚úÖ Implementado)
- [ ] (Futuro) Implementar gera√ß√£o autom√°tica ao completar curso
- [ ] (Futuro) Admin pode adicionar certificado manualmente
- [ ] (Futuro) Admin pode importar CSV com novos certificados

---

## üéØ Recomenda√ß√£o Imediata

**Para os 89 usu√°rios que j√° t√™m certificados:**

1. **Execute o SQL de cria√ß√£o de usu√°rios:**
   ```bash
   # Arquivo: SQL_CRIAR_USUARIOS_AUTH.sql
   # Cria ~95 contas com senha: 123456
   ```

2. **(Opcional) Envie email para cada um:**
   ```
   Assunto: Acesse seus certificados CCT 2026
   
   Ol√° [Nome],
   
   Seus certificados est√£o dispon√≠veis!
   
   Acesse: https://ensinoplus-dev-cct2026.n697dr.easypanel.host
   Email: [email]
   Senha: 123456
   
   Atenciosamente,
   CCT 2026
   ```

3. **Resultado:**
   - ‚úÖ Todos conseguem fazer login
   - ‚úÖ Todos veem seus certificados automaticamente
   - ‚úÖ Sistema funciona perfeitamente!

---

**Pronto! Sistema completo e escal√°vel.** üéâ

**Qualquer novo usu√°rio que se registrar:**
- Se tiver certificado na tabela ‚Üí Aparece automaticamente
- Se n√£o tiver ‚Üí V√™ mensagem "nenhum dispon√≠vel"
- No futuro ‚Üí Receber√° ao completar cursos

**Tudo baseado no match de email!** üìß
